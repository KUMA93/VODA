# Porting Manual   
<br/>

## Environment

**FrontEnd**  

- npm: `9.8.0`
- Node.js: `18.16.1`
- React: `16.13.0`
- Redux: `4.2.1`
- styled-components: `6.0.5`  


**DevOps**  

- Docker: `24.0.5`
- Nginx: `nginx/1.18.0`  

**Server**  

- AWS EC2: `ubuntu 20.04`
- IntelliJ: `IDEA 2023.2`
- SpringBoot: `2.7.14-SNAPSHOT`
- JDK: `openjdk 11.0.0.1`

- tensorflow/tfjs-core: `4.10.0`
- face-api.js: `0.22.2`

- flask: `2.3.2`
- flask-cors: `4.0.0`
- opencv-python: `4.8.x`  


**Database**  

- MySQL: `8.0.34-0ubuntu0.20.04.1`  


**Collaboration**  

- GitLab
- Jira
- Notion  

<br/>


## DB Setting

1. Create MySql account.

2. Run the S09P12A707/exec/resource/VODA_DB_Dump20230817.sql file in the workbench.

<br/>


## Build & Run in Local Environment

### Back-End
    * Running the Back-End server
    ```
    cd/back/calling
    ```
    * Run
    ```
    application Run
    ```

### Front-End 
    * Running the Front-End server

    ```
    cd/front/voda
    ```

    * Install packages
    ```
    npm install
    ```

    * Run
    ```
    npm start
    ```

### Flask
    * A flask server is used to recognize the color of an object. A separate run of this project is available at [Color-Recognition](#).  

If you want to use it with the web on a local server, follow the steps below.

    * Check file path(start from root)
    ```
    cd model/
    ```

    * Install virtual environment
    ```
    python -m venv venv
    ```

    * Run virtual environment
    ```
    source venv/Script/activate
    ```

    * Install requirements
    ```
    pip install -r requirements
    ```

    * Run
    ```
    python app.py
    ```
<br/>
      
## Project Build & Deploy

1. Update package
    
    ```bash
    sudo apt-get update
    ```
    
2. Install packages
    
    ```bash
    sudo apt-get install \
    		ca-certificates \
    		curl \
    		gnupg \
    		lsb-release
    ```
    
3. Register Official GPG Key (of Docker)
    
    ```bash
    sudo mkdir -p /etc/apt/keyrings
    
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    ```
    
4. Register stable repository
    
    ```bash
    echo \
    		"deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
      $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
    ```
    
5. Install Docker
    
    ```bash
    # install docker
    sudo apt-get update
    sudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose-plugin
    ```
    
6. Confirm Docker version
    
    ```bash
    # 도커 설치 확인
    sudo docker -v
    ```


### Nginx & SSL Setup

1. Nginx Setup
    
    ```bash
    sudo apt-get install nginx
    ```
    
2. Confirm Nginx version
    
    ```bash
    sudo nginx -v
    ```
    
3. Stop Nginx
    
    ```bash
    sudo systemctl stop nginx
    ```
    
4. Install Encrypt
    
    ```bash
    sudo apt-get install letsencrypt
    ```
    
5. Apply certificate and '.pem' key
    
    ```bash
    sudo letsencrypt certonly --standalone -d [domain]
    ```
    
6. Check Issuance route
    
    ```bash
    cd /etc/letsencrypt/live/[domain]
    ```
    
7. Create a conf file after Verifying the file path
    
    ```bash
    cd /etc/nginx/conf.d
    sudo vi default.conf
    ```
    
    ```bash
    # default.conf
    upstream frontend {
	    server 0.0.0.0:3000;
    }
    upstream backend {
        server 0.0.0.0:8080;
    }
    upstream flaskapp {
        server 0.0.0.0:5000;
    }

    server {
        listen 80;
        server_name i9a707.p.ssafy.io;
        
        return 301 https://$host$request_uri;
    }

    server {
        server_name vodavoda.site www.vodavoda.site;

        location / {
                proxy_pass http://frontend;
            }

        location /voda {
            rewrite ^/voda(/.*)$ $1 break;
            proxy_pass http://backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /flask {
            proxy_pass http://flaskapp;
        }	


        listen 443 ssl; # managed by Certbot
        ssl_certificate /etc/letsencrypt/live/www.vodavoda.site/fullchain.pem; # managed by Certbot
        ssl_certificate_key /etc/letsencrypt/live/www.vodavoda.site/privkey.pem; # managed by Certbot
        include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot



    }

    server {
        if ($host = www.vodavoda.site) {
            return 301 https://$host$request_uri;
        } # managed by Certbot


        if ($host = vodavoda.site) {
            return 301 https://$host$request_uri;
        } # managed by Certbot


        listen 80;
        server_name vodavoda.site www.vodavoda.site;
        return 404; # managed by Certbot




    }
    ```
    
8. Nginx Test
    
    ```bash
    sudo nginx -t
    ```
    
9. Nginx Restart
    
    ```bash
    sudo systemctl restart nginx
    ```
    
10. Check Nginx status
    
    ```bash
    sudo systemctl status nginx
    ```
<br/>

### Front-End 빌드 및 배포
1. node.js 빌드

    ```bash
    npm run build
    ```

2. DockerImage 빌드
    프로젝트의 최상단이자 Dockerfile이 있는 디렉토리(voda)에서 도커이미지를 빌드

    ```bash
    docker build -t [도커허브계정]/[도커이미지명] .
    ```

3. DockerImage 허브에 올리기

    ```bash
    docker push [도커허브계정]/[도커이미지명]
    ```

4. EC2 서버에서 해당 도커이미지 실행하기 (run 하면 알아서 pull 받는다.)

    ```bash
    docker run -d -p 3000:3000 [도커허브계정]/[도커이미지명]
    ```
<br/>

### Back-End 빌드 및 배포

1. application.properties resources 폴더에 위치시키기

    ```bash
    # context path 설정
    server.servlet.context-path=/voda
    # server port 설정
    server.port=8080

    # JDBC 드라이버 클래스 명 설정
    spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
    # JDBC url
    spring.datasource.url=jdbc:mysql://i9a707.p.ssafy.io/voda?characterEncoding=utf8
    # DB 연결 유저명
    spring.datasource.username=[DB유저명]
    # DB 연결 비밀번호
    spring.datasource.password=[DB패스워드]

    # JPA DB 종류
    spring.jpa.database=mysql
    # JPA lazy-loading 비활성화
    spring.jpa.open-in-view=false
    # JPA DDL 생성 비활성화
    spring.jpa.generate-ddl=false
    # JPA dialect 설정
    spring.jpa.database-platform=org.hibernate.dialect.MySQL5InnoDBDialect

    # -- hibernate SQL 로그 설정 --
    #spring.jpa.properties.hibernate.format_sql=true
    #logging.level.org.hibernate.type.descriptor.sql=trace
    #logging.level.org.hibernate.SQL=DEBUG
    #spring.jpa.show-sql=true
    #logging.level.org.hibernate=info
    # -------------------------------

    # -- Database Connection pool setting --
    # connection pool 최대 개수
    spring.datasource.hikari.maximum-pool-size=10
    # connection 초기 연결 쿼리
    spring.datasource.hikari.connection-init-sql=SELECT 1 FROM DUAL
    # connection 유휴 시간 설정
    spring.datasource.hikari.idleTimeout=10000
    # connection 타임아웃 시간 설정
    spring.datasource.hikari.connection-timeout=10000
    # connection 유효 시간 설정
    spring.datasource.hikari.validation-timeout=10000
    # connectnion 최대 생명 시간 설정
    spring.datasource.hikari.maxLifetime=580000

    # swagger URL 매칭 전략 설정
    spring.mvc.pathmatch.matching-strategy=ANT_PATH_MATCHER

    # logging 설정
    logging.level.root=info
    logging.level.com.voda.calling.test=debug

    # JWT 서명 secret key
    jwt.secret=[JWT_SECRET_KEY]

    # -- Email Authentication setting --
    # 이메일 SMTP 서버 domain
    spring.mail.host=smtp.gmail.com
    # SMTP 서버 port
    spring.mail.port=587
    # SMTP 서버 유저명
    spring.mail.username=[SMTP유저명]
    # SMTP 서버 패스워드
    spring.mail.password=[SMTP패스워드]
    # SMTP 인증 활성화
    spring.mail.properties.mail.smtp.auth=true
    # StartTLS 인증 활성화
    spring.mail.properties.mail.smtp.starttls.enable=true
    # SMTP 타임아웃 시간 설정
    spring.mail.properties.mail.smtp.timeout=5000

    # openvidu 서버 url
    openvidu.url=https://i9a707.p.ssafy.io:5433/
    # openvidu secret key
    openvidu.secret=[OPENVIDU_SECRET_KEY]

    # SSL key 키 저장소 위치
    server.ssl.key-store=classpath:keystore.p12
    # 키 저장소 타입
    server.ssl.key-store-type=PKCS12
    # 키 저장소 패스워드
    server.ssl.key-store-password=[SSL패스워드]
    ```

2. maven 빌드 
    maven-> clean ->package

3. DockerImage 빌드
    프로젝트의 최상단이자 Dockerfile이 있는 디렉토리(calling)에서 도커이미지를 빌드

    ```bash
    docker build -t [도커허브계정]/[도커이미지명] .
    ```

4. DockerImage 허브에 올리기

    ```bash
    docker push [도커허브계정]/[도커이미지명]
    ```

5. EC2 서버에서 해당 도커이미지 실행하기 (run 하면 알아서 pull 받는다.)

    ```bash
    docker run -d -p 8080:8080 [도커허브계정]/[도커이미지명]
    ```
<br/>
    
### flask 빌드 및 배포
1. DockerImage 빌드
    프로젝트의 최상단이자 Dockerfile이 있는 디렉토리(model)에서 도커이미지를 빌드

    ```bash
    docker build -t [도커허브계정]/[도커이미지명] .
    ```

2. DockerImage 허브에 올리기

    ```bash
    docker push [도커허브계정]/[도커이미지명]
    ```

3. EC2 서버에서 해당 도커이미지 실행하기 (run 하면 알아서 pull 받는다.)

    ```bash
    docker run -d -p 5000:5000 [도커허브계정]/[도커이미지명]
    ```
<br/><br/>
   
   
## 서비스 기능 설명
   
**회원가입** <br/>
![Alt text](resource/GIF/회원관리/회원가입.gif) <br/>

**비밀번호 변경 및 정보수정** <br/>
![Alt text](resource/GIF/회원관리/비밀번호변경_정보수정.gif) <br/>

**임시 비밀번호 발급** <br/>
![Alt text](resource/GIF/회원관리/임시비밀번호발급.gif) <br/>

**환경설정** <br/>
![Alt text](resource/GIF/회원관리/환경설정.gif) <br/>

**로그인** <br/>
![Alt text](resource/GIF/회원관리/로그인.gif) <br/>

**화면모드 토글로 변경** <br/>
![Alt text](resource/GIF/스크린타입/홈화면_테마토글.gif) <br/>

**친구검색 및 추가** <br/>
![Alt text](resource/GIF/영상통화/친구추가.gif) <br/>

**통화 알림** <br/>
![Alt text](resource/GIF/영상통화/통화알림.gif) <br/>

**표정듣기** <br/>
![Alt text](resource/GIF/영상통화/표정듣기-자막.gif) <br/>

**표정보내기** <br/>
![Alt text](resource/GIF/영상통화/표정보내기-자막.gif) <br/>

**색상인식** <br/>
![Alt text](resource/GIF/색상인식/색상인식.gif) <br/>

**고객의소리함 목록 및 상세보기** <br/>
![Alt text](resource/GIF/고객의소리함/고객의소리목록.gif) <br/>

**고객의소리함 글 작성** <br/>
![Alt text](resource/GIF/고객의소리함/고객의소리글작성.gif) <br/>

**고객의소리함 글 수정 및 삭제** <br/>
![Alt text](resource/GIF/고객의소리함/고객의소리수정삭제.gif) <br/>

**고객의소리함 댓글 작성** <br/>
![Alt text](resource/GIF/고객의소리함/고객의소리댓글.gif) <br/>





    
